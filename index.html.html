<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stock Dashboard — Google Sheets Embed</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2a; --text:#eef2ff; --muted:#90a4b4; --accent:#4cc9f0; --line:#21314a;}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:#0b1220; color:var(--text)}
    header{position:sticky; top:0; background:rgba(9,17,26,.7); backdrop-filter:blur(8px); border-bottom:1px solid var(--line)}
    .container{max-width:1100px; margin:0 auto; padding:16px}
    .nav{display:flex; align-items:center; gap:14px}
    .nav h1{margin:0; font-size:18px}
    .badge{font-size:12px; background:var(--accent); color:#05202b; padding:2px 8px; border-radius:999px}
    main .grid{display:grid; grid-template-columns:1fr; gap:16px; margin-top:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px 0; font-size:18px}
    .muted{color:var(--muted)}
    iframe{width:100%; height:68vh; border:0; border-radius:12px; background:#0b1220}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #26405a; color:#dfe8f7; text-decoration:none}
    .btn:hover{border-color:#4cc9f0; color:white}
    .field{display:flex; gap:8px; align-items:center; margin:8px 0}
    .field label{min-width:110px; font-size:14px; color:#cfe1ff}
    .field input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #334a6b; background:#0b1524; color:#e9f0ff; outline:none}
    .save{cursor:pointer; background:linear-gradient(180deg,#3dbff2,#2aa6de); color:#042133; border:0; border-radius:10px; padding:10px 14px; font-weight:600}
    .save:hover{filter:brightness(1.05)}
    .pill{display:inline-block; font-size:12px; padding:2px 8px; border:1px solid var(--line); border-radius:999px; color:#bcd0ea}
    footer{color:#90a4b4; font-size:12px; text-align:center; padding:24px 0 40px}
    .tips code{background:#0b1524; border:1px solid #23304a; padding:2px 6px; border-radius:6px; color:#dfe8f7}
    #chart{height:420px}
  </style>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    // Helpers for localStorage
    const getCfg = () => ({
      url: localStorage.getItem('sheet_pub_url') || '',
      gid: localStorage.getItem('sheet_gid') || '0',
      query: localStorage.getItem('chart_query') || 'select A,B where A is not null'
    });
    const setCfg = (url, gid, query) => {
      localStorage.setItem('sheet_pub_url', url.trim());
      localStorage.setItem('sheet_gid', gid.trim());
      localStorage.setItem('chart_query', query.trim());
    };
    const pubToGviz = (pubUrl) => pubUrl.replace('/pubhtml','/gviz/tq');
    const applyIframe = () => {
      const {url} = getCfg();
      const src = url ? (url.includes('pubhtml') ? url : url) : 'about:blank';
      document.getElementById('sheet-frame').src = src ? (src.includes('pubhtml')? src+'?widget=true&headers=false' : src) : 'about:blank';
    };

    google.charts.load('current', {packages: ['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart(){
      const {url, gid, query} = getCfg();
      const container = document.getElementById('chart');
      if(!url || !gid){
        container.innerHTML = "<div class='muted'>กรุณาตั้งค่า <strong>Publish to web URL</strong> และ <strong>gid</strong> ในส่วน Settings</div>";
        return;
      }
      const base = pubToGviz(url);
      const tq = encodeURIComponent(query);
      const full = `${base}?gid=${gid}&tq=${tq}`;
      const queryObj = new google.visualization.Query(full);
      queryObj.send(resp => {
        if (resp.isError()) {
          container.innerHTML = "<div class='muted'>โหลดข้อมูลไม่สำเร็จ (ตรวจ URL/gid/query)</div>";
          return;
        }
        const data = resp.getDataTable();
        const chart = new google.visualization.PieChart(container);
        chart.draw(data, {
          legend: {position: 'right', textStyle:{color:'#dfe8f7'}},
          backgroundColor: 'transparent',
          chartArea: {left:10, top:10, width:'85%', height:'85%'},
          pieHole: 0.45
        });
      });
    }

    function handleSave(){
      const url = document.getElementById('url').value;
      const gid = document.getElementById('gid').value;
      const query = document.getElementById('query').value;
      setCfg(url,gid,query);
      applyIframe();
      drawChart();
      alert('บันทึกแล้ว! (ค่าเก็บไว้ในเบราว์เซอร์เครื่องนี้)');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const {url, gid, query} = getCfg();
      document.getElementById('url').value = url;
      document.getElementById('gid').value = gid;
      document.getElementById('query').value = query;
      applyIframe();
    });
  </script>
</head>
<body>
  <header>
    <div class="container nav">
      <h1>Stock Dashboard <span class="badge">Free</span></h1>
      <a class="btn" href="https://docs.google.com" target="_blank" rel="noopener">เปิด Google Sheets</a>
      <span class="pill">Publish → Embed → Chart</span>
    </div>
  </header>
  <main class="container">
    <div class="grid">
      <div class="card">
        <h2>Settings</h2>
        <p class="muted">1) ใน Google Sheets ไปที่ <em>File → Share → Publish to web</em> แล้วคัดลอกลิงก์ (ต้องเห็น <code>/pubhtml</code>) 2) วางลิงก์และ <code>gid</code> ด้านล่าง</p>
        <div class="field"><label>Publish URL</label><input id="url" placeholder="https://docs.google.com/spreadsheets/d/....../pubhtml"></div>
        <div class="field"><label>gid</label><input id="gid" placeholder="เช่น 0 หรือ 123456789"></div>
        <div class="field"><label>Chart Query</label><input id="query" placeholder="select A,B where A is not null"></div>
        <div class="row"><button class="save" onclick="handleSave()">บันทึกและรีเฟรช</button></div>
        <p class="muted tips">ตัวอย่างการใช้งานกราฟ: ถ้าในชีตของคุณมีตารางสรุป <code>Category | Count</code> อยู่ที่คอลัมน์ A:B ให้ใช้ Query: <code>select A,B where A is not null</code>. หากอยู่คอลัมน์อื่น ปรับเป็น <code>select D,E</code> เป็นต้น</p>
      </div>
      <div class="card">
        <h2>Embedded Sheet</h2>
        <iframe id="sheet-frame" src="about:blank"></iframe>
      </div>
      <div class="card">
        <h2>Allocation Chart</h2>
        <p class="muted">ดึงจากชีตเดียวกันโดยใช้ Google Charts (แก้ Query ให้ตรงกับช่วงข้อมูลจริง)</p>
        <div id="chart"></div>
      </div>
      <div class="card">
        <h2>คำแนะนำการนำไปออนไลน์ (ฟรี)</h2>
        <div class="row">
          <div>
            <h3>Google Sites</h3>
            <ol class="muted">
              <li>Publish ชีตของคุณ</li>
              <li>ไปที่ <a href="https://sites.google.com" target="_blank" rel="noopener">Google Sites</a> → Insert → Embed → วาง URL</li>
              <li>Publish เว็บไซต์</li>
            </ol>
          </div>
          <div>
            <h3>GitHub Pages</h3>
            <ol class="muted">
              <li>สร้าง repo ใหม่ชื่อ <code>stock-dashboard</code></li>
              <li>อัปโหลดไฟล์ <code>index.html</code> นี้</li>
              <li>Settings → Pages → เปิดใช้งาน</li>
            </ol>
          </div>
          <div>
            <h3>Netlify / Vercel</h3>
            <ol class="muted">
              <li>ลากไฟล์ <code>index.html</code> ไปวางเพื่อ deploy</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer>© 2025 Your Brand — ใช้ได้ฟรี • ปรับชื่อ/โลโก้และโทนสีได้ตามต้องการ</footer>
</body>
</html>
